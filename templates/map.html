{% extends 'base.html' %}
{% load static %}
{% block title %}Mapa{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/map.css' %}">
{% endblock %}

{% block main %}
<form method="POST">
  {% csrf_token %}
  <div class="position-absolute start-50 top-50 translate-middle d-flex flex-column align-items-center justify-content-center gap-2">
    <h4>Pokazuj znaczniki:</h4>
    <input id="filter1" class="btn btn-success" value="Tylko z twojego miasta">
    <input id="filter2" class="btn btn-success" value="Wszystkie">
  </div>
</form>
<div id="map"></div>
  <script type="text/javascript">
    let map;
    let markers = [];
    class Marker {
      constructor(location, title, content, icon) {
        const infowindow = new google.maps.InfoWindow({
          content: content,
        });
        const marker = new google.maps.Marker({
          position: location,
          map: map,
          title: title,
          // icon: icon
        });
        marker.addListener("click", () => {
          infowindow.open({
            anchor: marker,
            map,
            shouldFocus: false,
          });
        });
      }
    }
    function initialize() {
      const {{userHomeMarker.title}} = {lat: {{userHomeMarker.latitude}}, lng: {{userHomeMarker.longitude}}}
      {% for marker in allMarkers %}
      const {{marker.title}} = {lat: {{marker.latitude}}, lng: {{marker.longitude}}}
      {% endfor %}
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: {{userLocation}},
      });
      map.addListener("zoom_changed", () => {
        // console.log(map.getZoom());
        if (map.getZoom() < 11){
          
        }
      });
      const filter1 = document.getElementById('filter1')
      const filter2 = document.getElementById('filter2')
      function loadAllMarkers(){
        const marker{{userHomeMarker.id}} = new Marker({{userHomeMarker.title}}, "{{userHomeMarker.title}}", `{{userHomeMarker.content|safe}}`, "{{userHomeMarker.icon|safe}}");
        {% for marker in allMarkers %}
        const marker{{marker.id}} = new Marker({{marker.title}}, "{{marker.title}}", `{{marker.content|safe}}`, "{{marker.icon|safe}}");
        {% endfor %}
        document.getElementById('map').style.display = 'block';
      }
      function loadCityMarkers(){
        const marker{{userHomeMarker.id}} = new Marker({{userHomeMarker.title}}, "{{userHomeMarker.title}}", `{{userHomeMarker.content|safe}}`, "{{userHomeMarker.icon|safe}}");
        {% for marker in cityMarkers %}
        const marker{{marker.id}} = new Marker({{marker.title}}, "{{marker.title}}", `{{marker.content|safe}}`, "{{marker.icon|safe}}");
        {% endfor %}
        filter1.style.display = 'none';        
        filter2.style.display = 'none';        
        document.getElementById('map').style.display = 'block';
      }
      filter1.addEventListener('click', loadCityMarkers);
      filter2.addEventListener('click', loadAllMarkers);
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key={{api_key}}&callback=initialize"
    async defer></script>
{% endblock %}